name: Release

on:
  push:
    branches:
      - test
      - prod
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prod: ${{ steps.branch.outputs.is_prod }}
      is_test: ${{ steps.branch.outputs.is_test }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          elif [[ $GITHUB_REF == refs/heads/prod ]]; then
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
          elif [[ $GITHUB_REF == refs/heads/test ]]; then
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")-test.$(git rev-parse --short HEAD)
          else
            VERSION="v0.0.0-dev.$(git rev-parse --short HEAD)"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
      
      - name: Determine branch type
        id: branch
        run: |
          if [[ $GITHUB_REF == refs/heads/prod ]] || [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "is_prod=true" >> $GITHUB_OUTPUT
            echo "is_test=false" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/heads/test ]]; then
            echo "is_prod=false" >> $GITHUB_OUTPUT
            echo "is_test=true" >> $GITHUB_OUTPUT
          else
            echo "is_prod=false" >> $GITHUB_OUTPUT
            echo "is_test=false" >> $GITHUB_OUTPUT
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: prepare
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Run tests
        run: |
          go test -v -race ./...
      
      - name: Run go vet
        run: go vet ./...

  build-binaries:
    name: Build Binaries
    runs-on: ubuntu-latest
    needs: [prepare, test]
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            ext: ''
          - os: linux
            arch: arm64
            ext: ''
          - os: darwin
            arch: amd64
            ext: ''
          - os: darwin
            arch: arm64
            ext: ''
          - os: windows
            arch: amd64
            ext: '.exe'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Build binary
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          mkdir -p dist
          BINARY_NAME="getblobz-${VERSION}-${GOOS}-${GOARCH}${{ matrix.ext }}"
          
          # Build with version info
          go build \
            -ldflags="-s -w -X main.version=${VERSION} -X main.commit=${GITHUB_SHA::8} -X main.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o "dist/${BINARY_NAME}" \
            main.go
          
          # Create checksum
          cd dist
          sha256sum "${BINARY_NAME}" > "${BINARY_NAME}.sha256"
          
          echo "Built: ${BINARY_NAME}"
          ls -lh "${BINARY_NAME}"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: binaries-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [prepare, test]
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=${{ needs.prepare.outputs.version }}
            type=raw,value=latest,enable=${{ needs.prepare.outputs.is_prod == 'true' }}
            type=raw,value=test,enable=${{ needs.prepare.outputs.is_test == 'true' }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [prepare, test, build-binaries, build-docker]
    if: needs.prepare.outputs.is_prod == 'true' || needs.prepare.outputs.is_test == 'true'
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      
      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f -name 'getblobz-*' -exec cp {} release/ \;
          cd release
          ls -lh
      
      - name: Generate release notes
        id: notes
        run: |
          VERSION=${{ needs.prepare.outputs.version }}
          BRANCH=${{ github.ref_name }}
          
          cat > release-notes.md << EOF
          # getblobz ${VERSION}
          
          Release from branch: \`${BRANCH}\`
          Commit: \`${GITHUB_SHA::8}\`
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Installation Options
          
          ### Option 1: Download Binary
          
          Download the appropriate binary for your platform from the assets below.
          
          **Linux (amd64)**
          \`\`\`bash
          curl -L -o getblobz https://github.com/${{ github.repository }}/releases/download/${VERSION}/getblobz-${VERSION}-linux-amd64
          chmod +x getblobz
          sudo mv getblobz /usr/local/bin/
          \`\`\`
          
          **macOS (Apple Silicon)**
          \`\`\`bash
          curl -L -o getblobz https://github.com/${{ github.repository }}/releases/download/${VERSION}/getblobz-${VERSION}-darwin-arm64
          chmod +x getblobz
          sudo mv getblobz /usr/local/bin/
          \`\`\`
          
          **Windows (PowerShell)**
          \`\`\`powershell
          Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${VERSION}/getblobz-${VERSION}-windows-amd64.exe" -OutFile "getblobz.exe"
          \`\`\`
          
          ### Option 2: Docker
          
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository }}:${VERSION}
          docker run --rm ghcr.io/${{ github.repository }}:${VERSION} --version
          \`\`\`
          
          ### Option 3: Build from Source
          
          \`\`\`bash
          git clone https://github.com/${{ github.repository }}.git
          cd getblobz
          git checkout ${VERSION}
          go build -o getblobz main.go
          \`\`\`
          
          ## Verification
          
          Verify checksums:
          \`\`\`bash
          sha256sum -c getblobz-${VERSION}-linux-amd64.sha256
          \`\`\`
          
          ## What's Changed
          
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${VERSION}/CHANGELOG.md) for detailed changes.
          
          ## Documentation
          
          - [README.md](https://github.com/${{ github.repository }}/blob/${VERSION}/README.md)
          - [QUICKSTART.md](https://github.com/${{ github.repository }}/blob/${VERSION}/QUICKSTART.md)
          - [BUILD.md](https://github.com/${{ github.repository }}/blob/${VERSION}/BUILD.md)
          EOF
          
          cat release-notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          name: Release ${{ needs.prepare.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_test == 'true' }}
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate install script
        run: |
          cat > install.sh << 'INSTALLSCRIPT'
          #!/bin/bash
          set -e
          
          # getblobz installation script
          
          VERSION="${1:-latest}"
          INSTALL_DIR="${2:-/usr/local/bin}"
          
          echo "Installing getblobz ${VERSION}..."
          
          # Detect OS and architecture
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)
          
          case "$ARCH" in
              x86_64)
                  ARCH="amd64"
                  ;;
              aarch64|arm64)
                  ARCH="arm64"
                  ;;
              *)
                  echo "Unsupported architecture: $ARCH"
                  exit 1
                  ;;
          esac
          
          BINARY_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/getblobz-${VERSION}-${OS}-${ARCH}"
          
          echo "Downloading from: ${BINARY_URL}"
          
          # Download binary
          curl -L -o getblobz "${BINARY_URL}"
          chmod +x getblobz
          
          # Install
          if [ -w "$INSTALL_DIR" ]; then
              mv getblobz "${INSTALL_DIR}/getblobz"
          else
              sudo mv getblobz "${INSTALL_DIR}/getblobz"
          fi
          
          echo "âœ“ getblobz installed to ${INSTALL_DIR}/getblobz"
          echo ""
          echo "Run 'getblobz --version' to verify installation"
          INSTALLSCRIPT
          
          chmod +x install.sh
      
      - name: Upload install script
        uses: actions/upload-artifact@v3
        with:
          name: install-script
          path: install.sh

  update-docker-readme:
    name: Update Docker Hub README
    runs-on: ubuntu-latest
    needs: [prepare, create-release]
    if: needs.prepare.outputs.is_prod == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create Docker Hub README
        run: |
          cat > DOCKER_README.md << 'EOF'
          # getblobz Docker Image
          
          Official Docker image for getblobz - Azure Blob Storage sync tool.
          
          ## Quick Start
          
          ```bash
          docker run --rm \
            -v $(pwd)/data:/data \
            -e GETBLOBZ_CONNECTION_STRING="your-connection-string" \
            ghcr.io/${{ github.repository }}:latest sync \
            --container mycontainer
          ```
          
          ## Tags
          
          - `latest` - Latest stable release
          - `test` - Latest test release
          - `vX.Y.Z` - Specific version
          
          ## Documentation
          
          Full documentation: https://github.com/${{ github.repository }}
          
          ## Source
          
          GitHub: https://github.com/${{ github.repository }}
          EOF

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [prepare, create-release]
    if: always() && (needs.prepare.outputs.is_prod == 'true' || needs.prepare.outputs.is_test == 'true')
    
    steps:
      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Production**: ${{ needs.prepare.outputs.is_prod }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test**: ${{ needs.prepare.outputs.is_test }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Assets" >> $GITHUB_STEP_SUMMARY
          echo "- Binaries: Linux, macOS, Windows (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: ghcr.io/${{ github.repository }}:${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL**: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
